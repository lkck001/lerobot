# Transformer 位置编码中指数频率设计的直观理解

## 1. 括号里的到底是不是“频率”？

以一维为例：

\[
f_i(t) = \sin\left(\frac{1}{10000^{2i/D}} \cdot t\right)
\]

令：

\[
\omega_i = \frac{1}{10000^{2i/D}}
\]

则：

\[
f_i(t) = \sin(\omega_i t)
\]

在这里：

- \(\omega_i\) 叫“角频率”（angular frequency）
- 真正的频率：\(f_i = \dfrac{\omega_i}{2\pi}\)
- 周期：\(T_i = \dfrac{2\pi}{\omega_i}\)

所以：

- 括号里的整体 \(\omega_i t\) 是“相位”（phase）
- 其中的 \(\omega_i = 1/10000^{2i/D}\) 可以看作频率（差一个常数因子 \(2\pi\)）

更精确地说，可以理解为：

> f(t) 括号中是 频率 × 位置，频率那一部分是 \(\frac{1}{10000^{2i/D}}\)。

---

## 2. 为什么要用指数（几何）分割，而不是用常数（线性）分割？

把那一项单独拿出来：

\[
\omega_i = 10000^{-2i/D}
\]

取以 10000 为底的对数：

\[
\log_{10000} \omega_i = -\frac{2i}{D}
\]

可以看出：

- 在 log 频率轴上，\(\omega_i\) 是“等间距”的
- 换到普通频率上，就是“从高到低的几何级数”

这就是“用指数去分割”的含义：

> 在对数尺度上均匀分布频率，用有限维度覆盖极大的周期区间。

如果改成线性分割，比如：

\[
\omega_i = \omega_\text{min} + i\Delta
\]

会出现的问题：

- 为了覆盖很大的频率范围，\(\Delta\) 必须很小
- 相邻两个频率 \(\omega_i\) 和 \(\omega_{i+1}\) 非常接近
- 对应的两个正弦波在很长一段 t 上几乎重合
- 对应的两个维度所携带的信息高度冗余，很难提供新的区分度

而指数分割带来的效果：

- 前面高频部分频率较密，对局部位置差异分辨率更高
- 后面频率呈几何级数下降，周期迅速增大，可以覆盖非常远的位置差异
- 用有限的 D（几十到几百维），就能从极短周期一直覆盖到极长周期

这就是那句“可以极大的扩展周期区间”的数学原因。

---

## 3. 和“让每个词向量的位置编码尽可能区别开来”的关系

位置编码的形式可以写成：

\[
PE(t) = \big[ \sin(\omega_0 t), \cos(\omega_0 t), \sin(\omega_1 t), \cos(\omega_1 t), \dots \big]
\]

每个位置 t 被编码成一个“多频率指纹”：

- 相邻 token 的差异主要体现为高频维度上的显著变化，高频对小位移很敏感
- 相隔很远的 token 的差异主要体现在低频维度上，低频在长距离上仍然能保持相位差

因此，不同 t 在所有维度上的组合值，在高维空间中会形成几乎唯一的模式。

可以更准确地说：

- 不需要强行让每一列之间差异都巨大
- 而是要让每一维对应的频率在 log 尺度上错开，保证：
  - 有分辨局部的高频成分
  - 也有区分长距离位置的低频成分
- 这样不同位置 t 在这些多频率成分上的组合，整体上就足够可区分

一个直观比喻：

- 每个维度是一把不同刻度的尺子
- 高频维度是短尺子，刻度密，看清局部小差异
- 低频维度是长尺子，刻度疏，却能覆盖长距离
- 多把不同长度的尺子一起用，就能在巨大范围内给每个位置一个几乎独特的坐标指纹。

---

## 4. 指数分割的三个核心好处

用 \(10000^{2i/D}\) 这种指数方式，而不是线性间距，主要有三点优势：

1. 多尺度覆盖（multi-scale）
   - 高频维度编码局部位置差异
   - 低频维度编码长距离位置关系

2. 覆盖范围极大（large span）
   - 频率按几何级数下降，周期按几何级数增大
   - 用有限的 D 覆盖很长的序列长度，从几十到上万 token

3. 位置编码几乎唯一（near-uniqueness）
   - 不同 t 的正弦和余弦组合在高维空间中相似度很低
   - 自注意力中的点积等操作可以可靠地利用这些编码，感知绝对和相对位置

---

## 5. 一句话总结

- \(1/10000^{2i/D}\) 中的指数设计，让频率在对数尺度上等间距分布
- 这能在有限维度内同时捕捉局部和远距离的位置信息
- 从而使不同位置的编码在高维空间中具有足够的可区分性，这正是 Transformer 位置编码设计的核心直觉

---

## 6. 进阶：为什么要用 log 函数去展示？

我们通常会用 log 函数来分析这些频率，原因主要有三点：

1. **让人类看清“指数规律”**
   - 原始频率 \(\omega_i = 10000^{-2i/D}\) 是一个指数衰减的曲线，不容易直观判断其规律。
   - 取 log 后，\(\log \omega_i = -\frac{2i}{D}\) 变成了关于 \(i\) 的**线性函数（直线）**。
   - 这让我们一眼就能确认：频率是按照固定的比例（几何级数）在变化的，而不是杂乱无章的。

2. **理解“对数尺度上均匀分布”的真意**
   - 这句话意味着相邻频率之间的**比值是恒定的**（例如 \(\omega_{i} / \omega_{i+1} = \text{常数}\)）。
   - 相比之下，普通线性分布（如 10, 20, 30...）是**差值恒定**。
   - 在处理跨越多个数量级的物理量（如声音的分贝、地震级数、或者这里的位置跨度）时，我们更关心“倍数变化”而非“线性差值”。

3. **直观验证“多尺度覆盖”**
   - 只有在 log 尺度上均匀分布，才能保证每一个数量级（从极短周期到极长周期）都有专门的维度去覆盖。
   - 这验证了位置编码的设计目标：用有限的维度，均匀地照顾到从局部微小差异到全局巨大跨度的所有位置信息。

---

## 7. 相对位置编码：为什么是 \(R_{q-k}\)，而不是 \(p_q - p_k\)？

很多推导会把加入绝对位置编码后的注意力打分写成：

\[
A_{q,k}=(x_q+p_q)^\top W (x_k+p_k)
\]

展开后会出现与位置相关的项（例如位置-位置项）：

\[
p_q^\top W p_k
\]

直觉上我们想让注意力更多依赖“相对距离”，即只依赖 \((q-k)\)。关键点是：相对位置编码里出现的 \(R_{q-k}\) 通常不是直接做向量差 \(p_q-p_k\)，而是把绝对位置编码里正弦/余弦的组合用三角恒等式改写成只依赖差值的形式。

### 7.1 先澄清：q 和 k 是什么？

- \(q\)、\(k\) 是序列中的位置索引（第 q 个 token、第 k 个 token），是整数编号。
- \(p_q\) 表示位置 q 的位置编码向量，\(p_k\) 表示位置 k 的位置编码向量。

因此 \(q-k\) 的意义是：两个 token 之间的相对距离（方向与步数）。

### 7.2 为什么会自然得到 \(f_i(q-k)\) 这种形式？

假设某个频率 \(\omega\) 对应的二维位置编码是：

\[
[\sin(\omega t),\cos(\omega t)]
\]

在点积或双线性形式的展开中，会出现 \(\sin(\omega q)\)、\(\cos(\omega q)\) 与 \(\sin(\omega k)\)、\(\cos(\omega k)\) 的乘积项。这些项可以用三角恒等式改写为只依赖 \((q-k)\) 的形式，例如：

\[
\cos(\omega q)\cos(\omega k)+\sin(\omega q)\sin(\omega k)=\cos(\omega(q-k))
\]

\[
\sin(\omega q)\cos(\omega k)-\cos(\omega q)\sin(\omega k)=\sin(\omega(q-k))
\]

因此，把不同频率下的 \(\sin(\omega_i(q-k))\)、\(\cos(\omega_i(q-k))\) 拼起来，就得到一个只依赖相对距离的向量：

\[
R_{q-k}=\big[f_1(q-k),f_2(q-k),\dots\big]^\top
\]

其中 \(f_i(q-k)\) 可以理解为“第 i 个频率（或第 i 个通道）在相对距离 \((q-k)\) 处的基函数取值”，常见就是某个频率下的正弦或余弦。

### 7.3 为什么不是直接用 \(p_q-p_k\)？

- \(p_q-p_k\) 仍然显式依赖两个绝对位置 \(q\) 和 \(k\)，并不天然等价于注意力里出现的乘积型关系（如 \(p_q^\top W p_k\)）。
- 相对位置编码的关键不是“做差”，而是利用正弦/余弦在乘积/点积意义下的性质，把绝对位置的组合改写成“相位差”，即 \(\omega(q-k)\)。

因此更准确的表述是：\(R_{q-k}\) 表达的是位置编码的相位差（phase difference）所产生的相对距离特征，而不是简单的向量相减。

---

## 8. 最小例子：从 \(f(q,k)\) 推到只依赖 \(q-k\)

为了看清楚 \(f_i(q-k)\) 是怎么从“绝对位置编码”里出现的，这里用一个最小可算例子说明从 \(f(q,k)\) 到相对形式的变化过程：

- 只用一个频率 \(\omega\)
- 位置编码是二维
- 先把线性变换 \(W\) 简化为单位矩阵 \(I\)

### 8.1 定义二维正弦位置编码

\[
p_t=\begin{bmatrix}\sin(\omega t)\\ \cos(\omega t)\end{bmatrix}
\]

其中 \(t\) 是位置索引（整数）。

### 8.2 定义一个位置-位置打分项

从展开式中抽出一个典型的“位置-位置”项，令：

\[
f(q,k)=p_q^\top p_k
\]

把它展开：

\[
f(q,k)=\sin(\omega q)\sin(\omega k)+\cos(\omega q)\cos(\omega k)
\]

### 8.3 用三角恒等式改写成差值形式

利用恒等式：

\[
\cos(a-b)=\cos a\cos b+\sin a\sin b
\]

令 \(a=\omega q,\ b=\omega k\)，得到：

\[
f(q,k)=\cos(\omega(q-k))
\]

这一步说明：虽然一开始写作 \(p_q^\top p_k\) 看起来依赖绝对位置 \(q\) 和 \(k\)，但它在数学上等价于只依赖相对距离 \((q-k)\) 的函数。

### 8.4 数值直观：同样的距离给同样的 \(f(q,k)\)

取 \(\omega=1\)。如果两对位置有相同的距离，那么 \(f(q,k)\) 会相同：

- \((q,k)=(5,2)\)，则 \(q-k=3\)，有 \(f(5,2)=\cos(3)\)
- \((q,k)=(4,1)\)，则 \(q-k=3\)，有 \(f(4,1)=\cos(3)\)

因此，相对位置项捕捉的是“距离与方向”，而不是“绝对位置编号本身”。

### 8.5 从单频率到 \(R_{q-k}\)

真实的正弦位置编码有很多频率 \(\omega_0,\omega_1,\dots\)。把不同频率下的 \(\cos(\omega_i(q-k))\)、\(\sin(\omega_i(q-k))\) 拼起来，就得到只依赖 \((q-k)\) 的相对位置向量：

\[
R_{q-k}=\big[f_1(q-k),f_2(q-k),\dots\big]^\top
\]

其中 \(f_i(q-k)\) 就可以理解为某个频率/通道在相对距离 \((q-k)\) 处的基函数取值，常见就是 \(\sin(\omega_i(q-k))\) 或 \(\cos(\omega_i(q-k))\)。

