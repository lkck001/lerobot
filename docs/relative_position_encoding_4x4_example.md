# 相对位置编码示例（4×4：时域与频域都变化）

你当前的 Markdown 预览不支持数学公式渲染（KaTeX/MathJax），所以所有 LaTeX（如 `$$...$$`、`\begin{bmatrix}`）都会原样显示。下面把内容改成“纯文本/等宽代码块”的写法，保证在任何 Markdown 预览里都能正确显示。

这份例子要说明的是：位置编码矩阵 P 的行（时域：位置索引 t）在变、列（频域：不同频率通道）也在变；但由 sin/cos 位置编码进入注意力打分的某些位置项，会自然变成只依赖 (q-k) 的相对形式。

为避免符号太多，这里只演示“位置-位置项”这一块的核心结构（对应你图里从 p_q^T W p_k 走向 v^T R_{q-k} 的思路）。

---

## 1. 构造一个 4×4 的位置编码矩阵 P

序列长度 L=4，位置索引 t ∈ {0,1,2,3}。

选两组频率（两种尺度）：
- 高频：ω0 = π/2
- 低频：ω1 = π/3

每个频率对应两列（sin/cos），因此总维度 d=4：

```text
p_t = [ sin(ω0·t), cos(ω0·t), sin(ω1·t), cos(ω1·t) ]
```

把 t=0,1,2,3 代入得到 P（行=时域，列=频域）：

```text
P (symbolic) =
[
  sin(0)        cos(0)        sin(0)          cos(0)
  sin(π/2)      cos(π/2)      sin(π/3)        cos(π/3)
  sin(π)        cos(π)        sin(2π/3)       cos(2π/3)
  sin(3π/2)     cos(3π/2)     sin(π)          cos(π)
]
```

对应的数值（用 sqrt(3)/2 和 1/2 表示精确值）：

```text
P (numeric) =
[
   0    1     0      1
   1    0   sqrt(3)/2  1/2
   0   -1   sqrt(3)/2 -1/2
  -1    0     0     -1
]
```

你可以直观看到：
- 时域变化：每一行（不同 t）的 sin/cos 值都在变
- 频域变化：不同列对应不同频率通道（ω0 与 ω1），变化速度也不同

---

## 2. 定义一个位置-位置项 f(q,k)

先用最能看清结构的版本：令 W=I（单位矩阵），定义

```text
f(q,k) = p_q · p_k   （点积）
```

把 p_t 的定义代入（把两组频率拆开看更清楚）：

```text
f(q,k)
 = [sin(ω0 q)sin(ω0 k) + cos(ω0 q)cos(ω0 k)]
 + [sin(ω1 q)sin(ω1 k) + cos(ω1 q)cos(ω1 k)]
```

用恒等式：cos(a-b) = cos(a)cos(b) + sin(a)sin(b)

于是每个频率块都变成“只依赖差值”的形式：

```text
sin(ω q)sin(ω k) + cos(ω q)cos(ω k) = cos(ω (q-k))
```

所以：

```text
f(q,k) = cos(ω0 (q-k)) + cos(ω1 (q-k))
```

这一步就是你关心的“从绝对位置 (q,k) 的乘积，变成只依赖相对距离 (q-k) 的函数”的核心。

---

## 3. 得到一个 4×4 的 f(q,k) 矩阵（相对结构显现）

令 F 是 4×4 矩阵，F[q,k] = f(q,k)。

只需要算 Δ = q-k ∈ {-3,-2,-1,0,1,2,3} 的值。

因为：
- ω0 = π/2 → cos(ω0 Δ) 变化很快（高频）
- ω1 = π/3 → cos(ω1 Δ) 变化较慢（低频）

逐个 Δ 计算：

```text
Δ =  0: f = cos(0)        + cos(0)        =  1 + 1   =  2
Δ = ±1: f = cos(π/2)      + cos(π/3)      =  0 + 1/2 =  0.5
Δ = ±2: f = cos(π)        + cos(2π/3)     = -1 - 1/2 = -1.5
Δ = ±3: f = cos(3π/2)     + cos(π)        =  0 - 1   = -1
```

于是：

```text
F =
[
  2     0.5   -1.5   -1
  0.5   2      0.5   -1.5
 -1.5   0.5    2      0.5
 -1    -1.5    0.5    2
]
```

观察结构：
- 每条斜对角线上的值相同（只取决于 q-k）
- 这就是典型的 Toeplitz 结构（相对位置结构）

---

## 4. “频域”分别贡献什么？（把两个频率通道拆开）

把 f 拆成两部分：

```text
f(q,k) = f^(0)(q,k) + f^(1)(q,k)
f^(0)(q,k) = cos(ω0 (q-k))
f^(1)(q,k) = cos(ω1 (q-k))
```

对应的两个 4×4 矩阵：

```text
F^(0) =
[
  1   0  -1   0
  0   1   0  -1
 -1   0   1   0
  0  -1   0   1
]

F^(1) =
[
  1    0.5  -0.5  -1
  0.5  1     0.5  -0.5
 -0.5  0.5   1     0.5
 -1   -0.5   0.5   1
]
```

并且 F = F^(0) + F^(1)。

直观上：
- 高频通道 F^(0) 对 Δ 的响应更剧烈（更“局部”）
- 低频通道 F^(1) 更平滑、覆盖更长范围（更“全局”）

---

## 5. 写成 v^T R_(q-k) 的形式（对应你图里的 R_(q-k)）

把“相对距离特征”定义成一个向量（四维，对应两组频率的 cos/sin）：

```text
R_Δ = [ cos(ω0 Δ), sin(ω0 Δ), cos(ω1 Δ), sin(ω1 Δ) ]^T   where Δ = q-k
```

取 v = [1, 0, 1, 0]^T，则：

```text
v^T R_(q-k) = cos(ω0 (q-k)) + cos(ω1 (q-k)) = f(q,k)
```

这里每个分量都可以对应你说的 f_i(q-k)：
- f1(q-k) = cos(ω0(q-k))
- f2(q-k) = sin(ω0(q-k))
- f3(q-k) = cos(ω1(q-k))
- f4(q-k) = sin(ω1(q-k))

真实模型里频率会更多（维度更高），v（或等价线性映射）是可学习的，从而学会“哪些频率/尺度更重要”。

---

## 6. 一句话结论

即使 P 的行（时域）和列（频域）都在变化，只要位置编码采用 sin/cos 这种“相位结构”，那么在注意力打分里出现的乘积项就可以用三角恒等式改写为只依赖 (q-k) 的函数；把多频率的这些函数值拼起来，就是 R_(q-k)（由一组 f_i(q-k) 组成的向量）。
